<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celebrity Recognition</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      text-align: center;
      padding: 20px;
    }
    img {
      max-width: 90%;
      max-height: 60vh;
      margin: 20px 0;
    }
    input {
      font-size: 18px;
      padding: 10px;
      width: 80%;
      max-width: 400px;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
    }
    .small {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="startScreen">
  <h1>Recognize the Celebrity</h1>
  <p>You’ll see 20 faces. Name as many celebrities as you can.</p>
  <button onclick="startRound()">Start round</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="progress"></div>
  <img id="celebrityImage">
  <p id="imageStatus" class="small"></p>
  <input id="guessInput" placeholder="Who is this?" autocomplete="off">
  <br>
  <button onclick="submitGuess()">Submit</button>
  <button onclick="skip()">Skip</button>
  <p id="feedback"></p>
</div>

<div id="endScreen" style="display:none;">
  <h2 id="headline"></h2>
  <p id="finalScore"></p>
  <button onclick="startRound()">Play another round</button>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vS52keBl1q6F8AVumY7iwghhuYyxm5n9XJdyHFVlBIdWTp4hN-IPvwseIo5cjJO_iUzJp7H6EQMIT6E/pub?output=csv";

const FACES_PER_ROUND = 20;
let allCelebrities = [];
let round = [];
let index = 0;
let score = 0;
const imageCache = {};

// ---------- ROBUST CSV PARSER ----------
function parseCSV(csv) {
  const rows = [];
  let row = [];
  let value = "";
  let inQuotes = false;

  for (let char of csv) {
    if (char === '"') inQuotes = !inQuotes;
    else if (char === "," && !inQuotes) {
      row.push(value);
      value = "";
    } else if (char === "\n" && !inQuotes) {
      row.push(value);
      rows.push(row);
      row = [];
      value = "";
    } else value += char;
  }
  row.push(value);
  rows.push(row);

  const headers = rows.shift().map(h => h.trim());

  return rows.map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = (r[i] || "").trim());
    return {
      name: obj.full_name,
      confidence: Number(obj.confidence_level)
    };
  }).filter(c => c.name);
}

// ---------- LOAD DATA ----------
fetch(CSV_URL)
  .then(res => res.text())
  .then(csv => {
    allCelebrities = parseCSV(csv);
  });

// ---------- ROUND BUILD ----------
function buildRound() {
  const anchors = allCelebrities.filter(c => c.confidence === 5);
  const traps = allCelebrities.filter(c => c.confidence === 4);
  const pressure = allCelebrities.filter(c => c.confidence <= 3);

  return [
    ...pickRandom(anchors, 6),
    ...pickRandom(traps, 8),
    ...pickRandom(pressure, 6)
  ].sort(() => Math.random() - 0.5);
}

function pickRandom(arr, n) {
  return [...arr].sort(() => Math.random() - 0.5).slice(0, n);
}

// ---------- GAME FLOW ----------
function startRound() {
  score = 0;
  index = 0;
  round = buildRound();

  startScreen.style.display = "none";
  endScreen.style.display = "none";
  gameScreen.style.display = "block";

  showFace();
}

function showFace() {
  progress.innerText = `Face ${index + 1} of ${FACES_PER_ROUND} | Score: ${score}`;
  guessInput.value = "";
  feedback.innerText = "";
  loadWikipediaImage(round[index].name);
}

function loadWikipediaImage(name) {
  imageStatus.innerText = "Loading image…";

  if (imageCache[name]) {
    celebrityImage.src = imageCache[name];
    imageStatus.innerText = "";
    return;
  }

  fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(data => {
      if (data.thumbnail?.source) {
        imageCache[name] = data.thumbnail.source;
        celebrityImage.src = data.thumbnail.source;
        imageStatus.innerText = "";
      } else {
        imageStatus.innerText = "Image not available";
        celebrityImage.src = "";
      }
    })
    .catch(() => {
      imageStatus.innerText = "Image not available";
      celebrityImage.src = "";
    });
}

function submitGuess() {
  const guess = guessInput.value.trim().toLowerCase();
  const correct = round[index].name.toLowerCase();

  if (guess === correct) {
    score += 10;
    feedback.innerText = "Correct! +10 points";
  } else {
    feedback.innerText = `Incorrect. Correct answer: ${round[index].name}`;
  }

  setTimeout(nextFace, 1200);
}

function skip() {
  nextFace();
}

function nextFace() {
  index++;
  if (index < FACES_PER_ROUND) showFace();
  else endRound();
}

function endRound() {
  gameScreen.style.display = "none";
  endScreen.style.display = "block";
  finalScore.innerText = `Your score: ${score} / ${FACES_PER_ROUND * 10}`;

  headline.innerText =
    score >= 160 ? "You really know your pop culture." :
    score >= 120 ? "Solid — but you left points on the table." :
    score >= 80 ? "You know the faces. The names are harder." :
    "Brutal round. Want another shot?";
}
</script>

</body>
</html>
